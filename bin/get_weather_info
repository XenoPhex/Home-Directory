#!/usr/bin/env ruby
require 'rubygems'
require 'net/http'
require 'uri'
require 'nokogiri'

api_url = "http://weather.yahooapis.com/forecastrss?p=USNJ0592&u=f"
rss_doc = Net::HTTP.get(URI(api_url))

parsed_weather = Nokogiri::XML rss_doc
today = parsed_weather.xpath("//yweather:forecast").first
sunrise = parsed_weather.xpath("//yweather:astronomy").attribute('sunrise').value
sunset = parsed_weather.xpath("//yweather:astronomy").attribute('sunset').value
current_temperature = parsed_weather.xpath("//yweather:condition").attribute('temp').value
today_high = today.attribute('high').value
today_low = today.attribute('low').value
today_description = today.attribute('text').value

puts "#{current_temperature}\xC2\xB0F - #{today_description}"
puts "High: #{today_high}\xC2\xB0F Low: #{today_low}\xC2\xB0F"
puts "Sunrise: #{sunrise.upcase} Sunset: #{sunset.upcase}"

require 'open-uri'
image_site = "http://weather.yahoo.com/united-states/new-jersey/north-plainfield-2461463/"
page = Nokogiri::HTML(open(image_site))

selected_element = page.css("div.forecast-icon").empty? ? page.css("div.current-weather") : page.css("div.forecast-icon")
image_url = selected_element[0]['style'].match(/http.*?\.png/).to_s

if image_url.empty?
  puts "[ Error obtaining Image URL ]"
  return
end
`curl -s #{image_url} -o /tmp/weather.png`
